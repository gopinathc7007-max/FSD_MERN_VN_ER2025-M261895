import { Booking } from '../models/bookingSchema.js';
import { Flight } from '../models/flightSchema.js';

export const bookTicket = async (req, res) => {
  const user = req.user.id;
  const { flight, flightName, flightId, departure, destination, email, mobile, passengers, totalPrice, journeyDate, journeyTime, seatClass } = req.body;

  try {
    const seatsToBook = passengers.length;

    const updatedFlight = await Flight.findOneAndUpdate(
      { _id: flight, availableSeats: { $gte: seatsToBook } },
      { $inc: { availableSeats: -seatsToBook } },
      { new: true }
    );

    if (!updatedFlight) {
      return res.status(400).json({ message: 'Not enough seats available' });
    }

    const bookings = await Booking.find({ flight, journeyDate, seatClass });
    const numBookedSeats = bookings.reduce((acc, b) => acc + b.passengers.length, 0);

    let seats = '';
    const seatCode = { economy: 'E', 'premium-economy': 'P', business: 'B', 'first-class': 'A' };
    const coach = seatCode[seatClass];

    for (let i = numBookedSeats + 1; i < numBookedSeats + passengers.length + 1; i++) {
      seats += (seats === '' ? '' : ', ') + coach + '-' + i;
    }

    const booking = new Booking({
      user, flight, flightName, flightId, departure, destination, email, mobile,
      passengers, totalPrice, journeyDate, journeyTime, seatClass, seats,
      bookingStatus: 'confirmed'
    });

    await booking.save();

    res.status(201).json({ message: 'Booking successful!', booking });
  } catch (err) {
    console.error('Booking error:', err);
    res.status(500).json({ message: 'Server error while booking', error: err.message });
  }
};

export const cancelTicket = async (req, res) => {
  const id = req.params.id;

  try {
    const booking = await Booking.findById(id);
    if (!booking) return res.status(404).json({ message: 'Booking not found' });

    if (booking.bookingStatus === 'cancelled')
      return res.status(400).json({ message: 'Booking already cancelled' });

    booking.bookingStatus = 'cancelled';
    await booking.save();

    const seatsToRelease = booking.passengers.length;
    await Flight.findByIdAndUpdate(
      booking.flight,
      { $inc: { availableSeats: seatsToRelease } }
    );

    res.json({ message: 'Booking cancelled and seats released successfully' });
  } catch (err) {
    console.error('Cancellation error:', err);
    res.status(500).json({ message: 'Server error while cancelling booking', error: err.message });
  }
};
